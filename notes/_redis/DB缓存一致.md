[一致性哈希算法][4422cbd2]
[分布式WebSocket集群解决方案][90b0a0a5]

  [4422cbd2]: https://blog.51cto.com/zero01/2115528 "一致性哈希算法"
  [90b0a0a5]: https://segmentfault.com/a/1190000017307713 "分布式WebSocket集群解决方案"

# redis怎么保证和数据库的一致性

## 设置缓存时间

从理论上来说，给缓存设置过期时间，是保证最终一致性的解决方案。

这种方案下，我们可以对存入缓存的数据设置过期时间，所有的写操作以数据库为准，对缓存操作只是尽最大努力即可。也就是说如果数据库写成功，缓存更新失败，那么只要到达过期时间，则后面的读请求自然会从数据库中读取新值然后回填缓存。

## 先删除缓存，再更新数据库，等读的时候再填充缓存

**导致缓存不一致的原因：**

1. 请求A进行写操作，删除缓存
2. 请求B查询发现缓存不存在
3. 请求B去数据库查询得到旧值
4. 请求B将旧值写入缓存
5. 请求A将新值写入数据库

上述情况就会导致不一致的情形出现。而且，如果不采用给缓存设置过期时间策略，该数据永远都是脏数据。

## 延时双删策略

```java
public void write(String key,Object data){
    redisUtils.del(key);
    db.update(data);
    Thread.Sleep(100);
    redisUtils.del(key);
}
```

1. 先淘汰缓存
2. 再写数据库（这两步和原来一样）
3. 休眠1秒，再次淘汰缓存

**这么做，可以将1秒内所造成的缓存脏数据，再次删除。**

## 将缓存删除失败记录到日志中，利用脚本提取失败记录再次删除(缓存失效期过长 7*24)
待续

---

参考文章：

[Redis缓存和数据库一致性问题][c6a06b40]

  [c6a06b40]: https://www.cnblogs.com/rjzheng/p/9041659.html "Redis缓存和数据库一致性问题"
