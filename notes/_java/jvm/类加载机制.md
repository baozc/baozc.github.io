---
layout: post
name: 类加载机制
position: Developer
# date: 2019-10-10 18:09:20
tag: jvm
category: jvm
---

> 加载、验证、准备、解析、初始化、使用、卸载

**加载、验证、准备、初始化顺序是固定的，解析则不一定**
连接：验证、准备、解析

# 加载
加载什么时候执行，没有强制约束

- 在类加载阶段，虚拟机要完成以下3件事情：

    1. 通过一个类的全限定名来获取定义此类的二进制字节流
        - `Class.forName` or `ClassLoader.getSystemClassLoader().loadClass`
        - 从zip包读取：JAR EAR WAR格式
        - 网络中获取
        - 运行时计算生成：动态代理
        - 由其它文件生成
    2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构
    3. 在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口

加载阶段与连接阶段的部分内容（如一部分字节码文件格式验证动作）是交叉进行的，加载阶段尚未完成，连接阶段可能已经开始，但这些夹在加载阶段之中进行的动作，仍然属于连接阶段的内容，这两个阶段的开始时间仍然保持着固定的先后顺序

# 验证
验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全

- 验证阶段大致上会完成下面4个阶段的验证动作

    1. 文件格式验证
        - 是否以魔数0xCAFEBABE开头
    2. 元数据验证
        -
    3. 字节码验证
    4. 符号引用验证

# 准备
- 准备阶段是正式为为变量分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在方法区中进行分配
    - 内存分配：仅包括类变量（被static修饰的变量），不包括实例变量，实例变量会在实例化时随着对象一起分配在java堆中
    - 初始值：数据类型的零值，`public static int value = 123` 0而不是123

# 解析
解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程
- 字段解析

# 初始化
初始化阶段是执行类构造器<clinit>()方法的过程

## 执行初始化的5种情况
1. 遇到`new`、`getstatic`、`putstatic`、`invokestatic`这4条字节码指令，常见的java代码场景：
    - 使用new关键字实例化对象
    - 读取或者设置一个类的静态字段
    - 调用一个类的静态方法
2. 使用java.lang.reflect包的方法对类进行反射调用的时候
3. 当初始化一个类时，发现父类还没有进行过初始化，则需要先触发其父类的初始化
4. 当虚拟机启动时，用户需要指定一个要执行的主类（包含main方法的类），虚拟机会先初始化这个主类
5. 当使用JDK1.7的动态语言支持时
